<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Selection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .seat-preferential {
            background-color: #4A5568;
            border: 4px solid #f88222;
        }

        .seat {
            width: 32px;
            height: 32px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .seat:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        @media (max-width: 640px) {
            .seat {
                width: 28px;
                height: 28px;
                margin: 3px;
                font-size: 12px;
            }
        }

        .seat-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            justify-content: center;
        }

        .row-label {
            width: 24px;
            text-align: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .seat-container {
            display: flex;
            gap: 8px;
        }

        #seatGrid {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media (min-width: 768px) {
            .responsive-container {
                display: flex;
            }
            .seat-section {
                width: 60%;
                padding-right: 2rem;
            }
            .info-section {
                width: 40%;
            }
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <h1 class="text-xl font-semibold">Choose Seat</h1>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 cursor-pointer" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
        </div>

        <div class="responsive-container">
            <div class="seat-section">
                <div class="relative mb-8">
                    <img src="../storage/img/seat.svg" alt="Screen" class="w-full mb-4">
                </div>

                <div id="seatGrid" class="mb-8">
                    <!-- Seats will be dynamically inserted here -->
                </div>

                <div class="flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-4">
                    <div class="flex items-center mb-2">
                        <div class="w-5 h-5 bg-gray-400 rounded-sm mr-2"></div>
                        <span class="text-xs sm:text-sm">Available</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <div class="w-5 h-5 bg-gray-600 rounded-sm mr-2"></div>
                        <span class="text-xs sm:text-sm">Reserved</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <div class="w-5 h-5 bg-red-600 rounded-sm mr-2"></div>
                        <span class="text-xs sm:text-sm">Selected</span>
                    </div>
                    <div class="flex items-center mb-2">
                        <div class="w-5 h-5 seat-preferential rounded-sm mr-2"></div>
                        <span class="text-xs sm:text-sm">Preferential</span>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <div id="datesList" class="flex overflow-x-auto space-x-2 mb-6">
                    <!-- Dates will be dynamically inserted here -->
                </div>

                <div id="functionsList" class="grid grid-cols-2 gap-2 mb-6">
                    <!-- Functions will be dynamically inserted here -->
                </div>

                <div class="flex justify-between items-center mb-4">
                    <p class="text-base sm:text-lg font-semibold">Price</p>
                    <p id="totalPrice" class="text-xl sm:text-2xl font-bold">$0.00</p>
                </div>

                <button id="buyButton"
                    class="w-full bg-red-600 text-white font-semibold py-2 sm:py-3 rounded-lg text-sm sm:text-base">
                    Buy ticket
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const datesList = document.getElementById('datesList');
            const functionsList = document.getElementById('functionsList');
            const seatGrid = document.getElementById('seatGrid');
            const totalPrice = document.getElementById('totalPrice');
            const buyButton = document.getElementById('buyButton');

            // Extract movieId from URL
            const urlParams = new URLSearchParams(window.location.search);
            const movieId = urlParams.get('movieId');

            if (!movieId) {
                console.error('No movie ID found in URL');
                alert('Error: No movie ID provided. Please go back and try again.');
                return;
            }
            
            let selectedSeats = [];

            async function getRoomDetails(roomId) {
                try {
                    const response = await fetch(`/seat/v1/rooms/${roomId}`);
                    if (!response.ok) throw new Error('Error fetching room details');
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    return null;
                }
            }

            async function getFunctions(movieId) {
                try {
                    const response = await fetch(`/seat/v1/functions/${movieId}`);
                    if (!response.ok) throw new Error('Error fetching functions');
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    return {};
                }
            }

            async function getSeats(roomId, functionId) {
                try {
                    const response = await fetch(`/seat/v1/seats/${roomId}/${functionId}`);
                    if (!response.ok) throw new Error('Error fetching seats');
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    return [];
                }
            }

            function displayDates(groupedFunctions) {
                datesList.innerHTML = '';
                Object.keys(groupedFunctions).forEach((date, index) => {
                    const button = document.createElement('button');
                    button.className = `flex-shrink-0 p-2 rounded-lg ${index === 0 ? 'bg-red-600' : 'bg-gray-800'}`;
                    button.innerHTML = `
                        <div class="text-center">
                            <p class="font-semibold text-xs sm:text-sm">Date</p>
                            <p class="text-xl sm:text-2xl font-bold">${date}</p>
                        </div>
                    `;
                    button.addEventListener('click', () => displayFunctions(groupedFunctions[date]));
                    datesList.appendChild(button);
                });
                // Display functions for the first date
                if (Object.keys(groupedFunctions).length > 0) {
                    displayFunctions(groupedFunctions[Object.keys(groupedFunctions)[0]]);
                }
            }

            async function displayFunctions(functions) {
                console.log('Received functions:', functions);
                functionsList.innerHTML = '';
                for (const func of functions) {
                    console.log('Individual function:', func);
                    const button = document.createElement('button');
                    button.className = 'bg-gray-800 p-2 rounded-lg text-left w-full mb-2';

                    let roomDetails = { tipo_sala: 'N/A', nombre: 'N/A' };
                    if (func.id_sala) {
                        roomDetails = await getRoomDetails(func.id_sala) || roomDetails;
                    }

                    button.innerHTML = `
                        <p class="text-base sm:text-lg font-bold">${func.hora_inicio || 'N/A'}</p>
                        <p class="text-xs sm:text-sm text-gray-400">${roomDetails.tipo_sala} - ${roomDetails.nombre}</p>
                    `;

                    button.addEventListener('click', () => {
                        if (func.id_sala) {
                            loadSeats(func.id_sala, func._id);
                        } else {
                            console.error('Room ID is missing for this function', func);
                            alert('Unable to load seats for this function. Please try another.');
                        }
                    });
                    functionsList.appendChild(button);
                }
            }

            async function loadSeats(roomId, functionId) {
                if (!roomId || !functionId) {
                    console.error('Invalid room ID or function ID');
                    return;
                }
                const seats = await getSeats(roomId, functionId);
                displaySeats(seats);
            }

            function displaySeats(seats) {
                seatGrid.innerHTML = '';
                
                // Sort seats by row and number
                seats.sort((a, b) => {
                    const [rowA, numA] = a.lugar.split('');
                    const [rowB, numB] = b.lugar.split('');
                    return rowA.localeCompare(rowB) || parseInt(numA) - parseInt(numB);
                });

                // Group seats by row
                const seatsByRow = seats.reduce((acc, seat) => {
                    const row = seat.lugar[0];
                    if (!acc[row]) acc[row] = [];
                    acc[row].push(seat);
                    return acc;
                }, {});

                // Create a container for the seats
                const seatContainer = document.createElement('div');
                seatContainer.className = 'grid gap-1 mb-8';

                // Display seats row by row
                Object.entries(seatsByRow).forEach(([row, rowSeats]) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'seat-row';
                    
                    // Add row label
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = row;
                    rowDiv.appendChild(rowLabel);

                    // Create seat container for this row
                    const seatRowContainer = document.createElement('div');
                    seatRowContainer.className = 'seat-container';

                    // Add seats for this row
                    rowSeats.forEach(seat => {
                        const seatButton = document.createElement('button');
                        seatButton.className = `seat rounded-sm ${seat.disponibilidad === 'disponible' ? 'bg-gray-400' : 'bg-gray-600'} ${seat.tipo_lugar === 'preferencial' ? 'seat-preferential' : ''}`;
                        seatButton.disabled = seat.disponibilidad !== 'disponible';
                        seatButton.dataset.seatId = seat._id;
                        seatButton.dataset.price = seat.precio;
                        seatButton.textContent = seat.lugar.slice(1); // Display only the seat number
                        seatButton.addEventListener('click', () => toggleSeatSelection(seatButton, seat));
                        seatRowContainer.appendChild(seatButton);
                    });

                    rowDiv.appendChild(seatRowContainer);
                    seatContainer.appendChild(rowDiv);
                });

                seatGrid.appendChild(seatContainer);
            }

            function toggleSeatSelection(seatButton, seat) {
                seatButton.classList.toggle('bg-red-600');

                const index = selectedSeats.findIndex(s => s._id === seat._id);
                if (index === -1) {
                    // Seat was not selected, add it to the selectedSeats array
                    selectedSeats.push(seat);
                } else {
                    // Seat was already selected, remove it from the selectedSeats array
                    selectedSeats.splice(index, 1);
                }

                // Update the total price
                updateTotalPrice();
            }

            function updateTotalPrice() {
                const total = selectedSeats.reduce((acc, seat) => acc + seat.precio, 0);
                totalPrice.innerText = `$${total.toFixed(2)}`;
            }

            function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            }
        

            getFunctions(movieId).then(displayDates);

            document.getElementById('buyButton').addEventListener('click', async () => {
            // Obtener la cookie del usuario
// Obtener la cookie 'token'

            const token = document.cookie.split('; ').find(row => row.startsWith('token='));

            if (!token) {
                console.error('No token found in cookies.');
                return;
            }

            // Decodificar el token URL-encoded
            const tokenValue = decodeURIComponent(token.split('=')[1]);

            try {
                // Parsear el token como JSON
                const payload = JSON.parse(tokenValue);
                console.log(payload);

                // Acceder al ID del usuario
                const userId = payload._id;
                console.log('User ID:', userId);
            } catch (error) {
                console.error('Error parsing token:', error);
            }



            // Decodificar la cookie
            // const user = JSON.parse(decodeURIComponent(cookieValue));

            // Verificar si hay asientos seleccionados
            if (!selectedSeats || selectedSeats.length === 0) {
                alert('No seats selected');
                return;
            }

            // Obtener el ID de la función seleccionada dinámicamente (por ejemplo, desde un dropdown o selector en el frontend)
            const selectedFunctionId = "66cff2dc8d26b5da40f46c3d"

            
            try {
                // Enviar la información al servidor para realizar la reserva
                const peticion = await fetch('/reserva/v1/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_usuario: this.userId, // ID del usuario desde la cookie
                        asientos: selectedSeats, // Array con IDs de los asientos seleccionados
                        id_horario_funcion: selectedFunctionId // ID de la función seleccionada
                    }),
                });

                if (peticion.ok) {
                    const data = await peticion.json();

                    // Guardar el ID de la reserva en el localStorage
                    localStorage.setItem('reservationId', data.reserva._id);

                    alert('Reservation successful!');
                    window.location.href = '/order'; // Redirigir a la página de confirmación
                } else {
                    const error = await peticion.json();
                    alert('Failed to make reservation. ' + error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error during reservation. Please try again later.');
            }
        });
        });
    </script>
</body>

</html>